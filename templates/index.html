<!DOCTYPE html>
<html>
  <head>
    <title>dynos eb2 pickit generator</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: #0d120d;
        color: #b3b3b3;
      }
      .container {
        max-width: 90%;
        margin: 0 auto;
        background: #161f16;
        padding: 20px;
        border-radius: 8px;
        border: solid 1px #090c09;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        box-sizing: border-box; /* Wichtig: Verhindert, dass Padding die Breite vergrößert */
      }
      h1 {
        color: #b3b3b3;
        margin-bottom: 30px;
        text-align: center;
      }
      .input-group {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 20px;
      }

      .input-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .input-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .input-row label {
        min-width: 150px;
      }

      button[type="submit"] {
        align-self: flex-end;
        height: 40px;
      }
      input[type="number"] {
        padding: 10px;
        border: 1px solid #161f16;
        background: #131712;
        color: #b3b3b3;
        border-radius: 4px;
        width: 150px;
        margin-right: 10px;
      }
      button {
        padding: 10px 20px;
        background: #131712;
        border: none;
        color: #b3b3b3;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background: #1c261f;
      }
      .results {
        width: 100%;
        margin-top: 20px;
        box-sizing: border-box; /* Wichtig für die Scrollbar */
      }
      textarea {
        width: 100%;
        height: 400px;
        margin-top: 20px;
        padding: 15px;
        background: #1c261f;
        color: #b3b3b3;
        border: 1px solid #090c09;
        border-radius: 4px;
        font-family: monospace;
        resize: vertical;
        box-sizing: border-box; /* Wichtig: Padding wird in Breite eingerechnet */
        overflow-x: hidden; /* Verhindert horizontales Scrollen */
        white-space: pre-wrap; /* Zeilenumbruch für lange Zeilen */
      }
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .progress {
        width: 100%;
        height: 4px;
        background: #090c09;
        border-radius: 2px;
        overflow: hidden;
      }
      .progress-bar {
        width: 0%;
        height: 100%;
        background: #131712;
        animation: progress 2s ease-in-out infinite;
      }
      @keyframes progress {
        0% {
          width: 0%;
        }
        50% {
          width: 100%;
        }
        100% {
          width: 0%;
        }
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .copy-button {
        padding: 10px 20px;
        background: #131712;
        border: none;
        color: #b3b3b3;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .copy-button:hover {
        background: #1c261f;
      }

      .copy-button.success {
        background: #1a3320;
      }

      .copy-icon {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      /* Styles for Currency Section */
      .currency-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #1c261f;
      }
      .currency-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(200px, 1fr)
        ); /* Responsive grid */
        gap: 10px;
        margin-top: 10px;
        max-height: 200px; /* Limit height and add scroll */
        overflow-y: auto; /* Enable vertical scroll */
        padding: 10px;
        background: #131712;
        border-radius: 4px;
        border: 1px solid #090c09;
      }
      .currency-grid label {
        display: block; /* Ensure labels take full width in grid cell */
        cursor: pointer;
      }
      .currency-grid label input[type="checkbox"] {
        margin-right: 8px;
      }
      .select-all-label {
        font-weight: bold;
        margin-bottom: 10px;
        display: block;
      }

      /* Styles for Rune Section */
      .rune-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #1c261f;
      }
      .rune-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(200px, 1fr)
        ); /* Responsive grid */
        gap: 10px 20px; /* Row and column gap */
        margin-top: 10px;
        max-height: 300px; /* Adjust height as needed */
        overflow-y: auto; /* Enable vertical scroll */
        padding: 10px;
        background: #131712;
        border-radius: 4px;
        border: 1px solid #090c09;
      }
      .rune-grid .category-header {
        grid-column: 1 / -1; /* Span full width */
        font-weight: bold;
        margin-top: 15px;
        margin-bottom: 5px;
        border-bottom: 1px solid #1c261f;
        padding-bottom: 5px;
      }
      .rune-grid .category-header:first-child {
        margin-top: 0; /* Remove top margin for the first header */
      }
      .rune-grid label {
        display: block; /* Ensure labels take full width in grid cell */
        cursor: pointer;
      }
      .rune-grid label input[type="checkbox"] {
        margin-right: 8px;
      }
      .rune-controls {
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }
      .rune-controls .select-all-label {
        margin-bottom: 0; /* Reset margin */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>dynos eb2 pickit generator</h1>
      <form method="POST">
        <div class="input-group">
          <div class="input-controls">
            <div class="input-row">
              <label>Minimum Exalted Price:</label>
              <input
                type="number"
                name="min_exalted"
                step="0.1"
                value="{{ min_exalted|default(10) }}"
              />
            </div>
            <div class="input-row">
              <label>
                <input
                  type="checkbox"
                  name="use_type"
                  id="use_type"
                  {%
                  if
                  use_type
                  %}checked{%
                  endif
                  %}
                />
                Use [Type]
              </label>
            </div>
          </div>
          <!-- Submit button moved below currency section -->
        </div>

        <!-- Currency Selection Section -->
        <div class="currency-section">
          <h2>Currency Filter</h2>
          <label class="select-all-label">
            <input
              type="checkbox"
              id="select-all-currency"
              onclick="toggleCurrencyCheckboxes(this.checked)"
            />
            Select/Deselect All Currencies
          </label>
          <div class="currency-grid">
            {% if all_currency_types %} {% for currency in all_currency_types %}
            <label>
              <input
                type="checkbox"
                name="currency_types"
                value="{{ currency }}"
                class="currency-checkbox"
                {%
                if
                currency
                in
                selected_currencies
                %}checked{%
                endif
                %}
              />
              {{ currency }}
            </label>
            {% endfor %} {% else %}
            <p>No currency types available.</p>
            {% endif %}
          </div>
        </div>
        <!-- End Currency Selection Section -->

        <!-- Rune Selection Section -->
        <div class="rune-section">
          <h2>Rune Filter</h2>
          <div class="rune-controls">
            <label class="select-all-label">
              <input
                type="checkbox"
                id="select-all-runes"
                onclick="toggleRuneCheckboxes(this.checked, null)"
              />
              Select/Deselect All Runes
            </label>
            {% if all_rune_types %} {% for category in all_rune_types.keys() %}
            <label class="select-all-label">
              <input
                type="checkbox"
                id="select-all-{{ category|lower }}-runes"
                onclick="toggleRuneCheckboxes(this.checked, '{{ category|lower }}')"
                class="rune-group-checkbox"
                data-category="{{ category|lower }}"
              />
              Select/Deselect {{ category }} Runes
            </label>
            {% endfor %} {% endif %}
          </div>
          <div class="rune-grid">
            {% if all_rune_types %} {% for category, runes in
            all_rune_types.items() %}
            <div class="category-header">{{ category }}</div>
            {% for rune in runes %}
            <label>
              <input
                type="checkbox"
                name="rune_types"
                value="{{ rune }}"
                class="rune-checkbox rune-{{ category|lower }}"
                data-category="{{ category|lower }}"
                {%
                if
                rune
                in
                selected_runes
                %}checked{%
                endif
                %}
              />
              {{ rune }}
            </label>
            {% endfor %} {% endfor %} {% else %}
            <p>No rune types available.</p>
            {% endif %}
          </div>
        </div>
        <!-- End Rune Selection Section -->

        <!-- Moved Generate Button -->
        <div style="text-align: right; margin-top: 20px">
          <button type="submit" onclick="showLoading()">Generate</button>
        </div>
      </form>

      <div class="loading" id="loading">
        <p>Generating filter...</p>
        <div class="progress">
          <div class="progress-bar"></div>
        </div>
      </div>
      {# Corrected structure: Only one outer check for results #}

      <!-- Combined Results Area -->
      {% if categories or currency_lines or rune_lines %} {# Added rune_lines
      check #}
      <!-- Anzeige des Datenalters -->
      <div class="data-age">
        <p>Data is {{ data_age }} old</p>
      </div>
      <div class="results">
        <textarea id="filterOutput" readonly>
{# --- Runes Section --- #}
{% if rune_lines %}
/////////////////////////////////////////////////////////////////////////////////////
//                                                                                 //
//                                     Runes                                       //
//                                                                                 //
/////////////////////////////////////////////////////////////////////////////////////

{% for item in rune_lines %}{{ item.line }}
{% endfor %}
{% endif %}

{# --- Currency Section --- #}
{% if currency_lines %}
{% if rune_lines %}

{% endif %} {# Add separator if runes exist #}
/////////////////////////////////////////////////////////////////////////////////////
//                                                                                 //
//                                  CURRENCY                                       //
//                                                                                 //
/////////////////////////////////////////////////////////////////////////////////////

{% for item in currency_lines %}{{ item.line }}
{% endfor %}
{% endif %}

{# --- Unique Items Section --- #}
{% if categories %}
{% if currency_lines or rune_lines %}

{% endif %} {# Add separator if currency or runes exist #}
/////////////////////////////////////////////////////////////////////////////////////
//                                                                                 //
//                                UNIQUE ITEMS                                     //
//                                                                                 //
/////////////////////////////////////////////////////////////////////////////////////

{% for category, items in categories.items() %}
// {{ category }}
{% for item in items %}{{ item.line }}
{% endfor %}

{% endfor %}{# End categories loop #}
{% endif %}{# End if categories #}
</textarea
        >
        <div class="button-group">
          <button class="copy-button" onclick="copyToClipboard()">
            <svg class="copy-icon" viewBox="0 0 24 24">
              <path
                d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
              />
            </svg>
            Copy to Clipboard
          </button>
        </div>
      </div>
      {% endif %} {# Closes the inner {% if categories or currency_lines %}
      block #} {# The original {% if categories %} block was removed, so its {%
      endif %} is no longer needed here #}
    </div>

    <script>
      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function copyToClipboard() {
        const textarea = document.getElementById("filterOutput");
        textarea.select();
        document.execCommand("copy");

        const button = document.querySelector(".copy-button");
        button.textContent = "Copied!";
        button.classList.add("success");

        setTimeout(() => {
          button.innerHTML = `
                    <svg class="copy-icon" viewBox="0 0 24 24">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                    Copy to Clipboard
                `;
          button.classList.remove("success");
        }, 2000);
      }

      // Function to toggle all currency checkboxes
      function toggleCurrencyCheckboxes(checked) {
        const checkboxes = document.querySelectorAll(".currency-checkbox");
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
      }

      // Function to toggle rune checkboxes (all or by category)
      function toggleRuneCheckboxes(checked, category) {
        const selector = category ? `.rune-${category}` : ".rune-checkbox";
        const checkboxes = document.querySelectorAll(selector);
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
        // Update the main "Select All Runes" checkbox state
        updateSelectAllRuneCheckbox();
        // Update the specific group checkbox state if applicable
        if (category) {
          updateRuneGroupCheckbox(category);
        } else {
          // If toggling all, update all group checkboxes
          document
            .querySelectorAll(".rune-group-checkbox")
            .forEach((groupCb) => {
              groupCb.checked = checked;
            });
        }
      }

      // Function to update the state of the main "Select All Runes" checkbox
      function updateSelectAllRuneCheckbox() {
        const selectAllRunesCheckbox =
          document.getElementById("select-all-runes");
        const allRuneCheckboxes = document.querySelectorAll(".rune-checkbox");
        if (!selectAllRunesCheckbox || allRuneCheckboxes.length === 0) return;

        let allChecked = true;
        allRuneCheckboxes.forEach((cb) => {
          if (!cb.checked) allChecked = false;
        });
        selectAllRunesCheckbox.checked = allChecked;
      }

      // Function to update the state of a specific rune group checkbox
      function updateRuneGroupCheckbox(category) {
        const groupCheckbox = document.getElementById(
          `select-all-${category}-runes`
        );
        const categoryCheckboxes = document.querySelectorAll(
          `.rune-${category}`
        );
        if (!groupCheckbox || categoryCheckboxes.length === 0) return;

        let allInCategoryChecked = true;
        categoryCheckboxes.forEach((cb) => {
          if (!cb.checked) allInCategoryChecked = false;
        });
        groupCheckbox.checked = allInCategoryChecked;
      }

      // Optional: Add event listener to uncheck "Select All" if any individual box is unchecked
      document.addEventListener("DOMContentLoaded", () => {
        // --- Currency Checkbox Logic ---
        const selectAllCurrencyCheckbox = document.getElementById(
          // Renamed variable
          "select-all-currency"
        );
        const individualCurrencyCheckboxes = // Renamed variable
          document.querySelectorAll(".currency-checkbox");

        individualCurrencyCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            if (!checkbox.checked) {
              selectAllCurrencyCheckbox.checked = false; // Use renamed variable
            } else {
              // Check if all currency checkboxes are checked now
              let allCurrencyChecked = true; // Renamed variable
              individualCurrencyCheckboxes.forEach((cb) => {
                if (!cb.checked) {
                  allCurrencyChecked = false; // Use renamed variable
                }
              });
              selectAllCurrencyCheckbox.checked = allCurrencyChecked; // Use renamed variable
            }
          });
        });

        // Set initial state of "Select All Currency" checkbox based on loaded selections
        if (selectAllCurrencyCheckbox) {
          let allCurrencyCheckedInitially = true; // Renamed variable
          if (individualCurrencyCheckboxes.length === 0) {
            allCurrencyCheckedInitially = false; // No checkboxes, so not all checked
          } else {
            individualCurrencyCheckboxes.forEach((cb) => {
              if (!cb.checked) {
                allCurrencyCheckedInitially = false; // Use renamed variable
              }
            });
          }
          selectAllCurrencyCheckbox.checked = allCurrencyCheckedInitially; // Use renamed variable
        }

        // --- Rune Checkbox Logic ---
        const selectAllRunesCheckbox =
          document.getElementById("select-all-runes");
        const individualRuneCheckboxes =
          document.querySelectorAll(".rune-checkbox");
        const groupRuneCheckboxes = document.querySelectorAll(
          ".rune-group-checkbox"
        );

        individualRuneCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            const category = checkbox.dataset.category;
            updateSelectAllRuneCheckbox(); // Update main select all
            if (category) {
              updateRuneGroupCheckbox(category); // Update specific group select all
            }
          });
        });

        // Set initial state for Rune checkboxes
        if (selectAllRunesCheckbox) {
          // Check if element exists
          updateSelectAllRuneCheckbox(); // Set main select all state
        }
        groupRuneCheckboxes.forEach((groupCb) => {
          // Set group select all states
          const category = groupCb.dataset.category;
          if (category) {
            updateRuneGroupCheckbox(category);
          }
        });
      });
    </script>
  </body>
</html>
